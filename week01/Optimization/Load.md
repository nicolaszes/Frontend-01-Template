#  Optimization Load Stage



<img src="https://static001.geekbang.org/resource/image/92/0a/925058a17cfbedff54e746db798c500a.png" alt="img" style="zoom:80%;" />

加载阶段渲染流水线

阻塞网页首次渲染的资源称为关键资源

* 关键资源个数
* 关键资源大小
* 请求资源需要多个 RTT(Round Time Trip)

###总的优化原则

#### 减少关键资源的个数

* Javascript 和 CSS 改成内联
* 没有 DOM 和 CSSOM 的操作的 script 脚本，改为 async，defer属性
* CSS Link 取消阻止显现（非关键资源）

#### 减少关键资源的大小

* 压缩 CSS 和 Javascript
* 移除 HTML，CSS，Javascript 文件注释

#### 减少关键资源 RTT

* CDN减少每次 RTT时长



#### Content

##### 延迟加载组件

什么才是一开始渲染页面所必须的？其余内容都可以等会儿。

JavaScript是分隔onload事件之前和之后的一个理想选择。例如，如果有JavaScript代码和支持拖放以及动画的库，这些都可以先等会儿，因为拖放元素是在页面最初渲染之后的。其它可以延迟加载的部分包括隐藏内容（在某个交互动作之后才出现的内容）和折叠的图片。



##### 预加载组件

充分利用浏览器空闲的时间来请求将来会用到的组件（图片，样式和脚本）。

实际应用中有以下几种预加载的类型：

- 无条件预加载——尽快开始加载，获取一些额外的组件。google.com就是一个sprite图片预加载的好例子，这个sprite图片并不是google.com主页需要的，而是搜索结果页面上的内容。
- 条件性预加载——根据用户操作猜测用户将要跳转到哪里并据此预加载。在[search.yahoo.com](http://search.yahoo.com/)的输入框里键入内容后，可以看到那些额外组件是怎样请求加载的。
- 提前预加载——在推出新设计之前预加载。经常在重新设计之后会听到：“这个新网站不错，但比以前更慢了”，一部分原因是用户访问先前的页面都是有旧缓存的，但新的却是一种空缓存状态下的体验。可以通过在将要推出新设计之前预加载一些组件来减轻这种负面影响，老站可以利用浏览器空闲的时间来请求那些新站需要的图片和脚本。



##### 减少DOM元素的数量

一个复杂的页面意味着要下载更多的字节，而且用JavaScript访问DOM也会更慢。



##### 跨域分离组件

分离组件可以最大化并行下载，但要确保只用不超过2-4个域，因为存在DNS查找的代价。



##### 尽量少用iframe

用iframe可以把一个HTML文档插入到父文档里，重要的是明白iframe是如何工作的并高效地使用它。

```
<iframe> 的优点
```

- 引入缓慢的第三方内容，比如标志和广告
- 安全沙箱
- 并行下载脚本

```
<iframe> 的缺点
```

- 代价高昂，即使是空白的iframe
- 阻塞页面加载
- 非语义



#### JS

##### 压缩

##### 去除重复脚本

##### 尽量减少DOM访问

用JavaScript访问DOM元素是很慢的，所以，为了让页面反应更迅速，应该：

- 缓存已访问过的元素的索引
- 先“离线”更新节点，再把它们添到DOM树上
- 避免用JavaScript修复布局问题



##### 用智能的事件处理器

事件委托机制：捕获/冒泡/目标阶段

##### 把脚本放在底部



#### CSS

##### 压缩

##### 选择<link>舍弃@import

FOUC

##### 避免使用CSS表达式

```css
background-color: expression((new Date()).getHours() % 2 ? "#B8D4FF" : "#F08A00");
```

##### 避免使用滤镜

IE专有的`AlphaImageLoader`滤镜可以用来修复IE7之前的版本中半透明PNG图片的问题。在图片加载过程中，这个滤镜会阻塞渲染，卡住浏览器，还会增加内存消耗而且是被应用到每个元素的，而不是每个图片，所以会存在一大堆问题。

最好的方法是干脆不要用`AlphaImageLoader`，而优雅地降级到用在IE中支持性很好的PNG8图片来代替。如果非要用`AlphaImageLoader`，应该用下划线hack：`_filter`来避免影响IE7及更高版本的用户。

##### 把样式表放在顶部

在Yahoo!研究性能的时候，我们发现把样式表放到文档的HEAD部分能让页面看起来加载地更快。这是因为把样式表放在head里能让页面逐步渲染。

关注性能的前端工程师想让页面逐步渲染。也就是说，我们想让浏览器尽快显示已有内容，这在页面上有一大堆内容或者用户网速很慢时显得尤为重要。给用户显示反馈（比如进度指标）的重要性已经被广泛研究过，并且被[记录](http://www.useit.com/papers/responsetime.html)下来了。在我们的例子中，HTML页面就是进度指标！当浏览器逐渐加载页面头部，导航条，顶部logo等等内容的时候，这些都被正在等待页面加载的用户当作反馈，能够提高整体用户体验。



#### 图片

##### 压缩

##### 避免图片src属性为空

